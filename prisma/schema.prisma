// Test schema - PostgreSQL for enterprise-grade testing
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  username  String   @unique
  password  String
  firstName String
  lastName  String
  phone     String?
  avatar    String?
  role      String   @default("USER")
  isActive  Boolean  @default(true)
  isEmailVerified Boolean @default(false)

  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  lastLoginAt DateTime?

  // Relationships
  calculatedPerformances SupplierPerformance[] @relation("PerformanceCalculator")
  reviewedPerformances SupplierPerformance[] @relation("PerformanceReviewer")
  resolvedEvents SupplierPerformanceEvent[] @relation("EventResolver")
  conductedReviews SupplierPerformanceReview[] @relation("PerformanceReviewBy")

  @@map("users")
  @@index([email])
  @@index([isActive])
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  refreshToken String? @unique
  expiresAt DateTime
  isActive  Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("sessions")
}

model ProductCategory {
  id          String   @id @default(cuid())
  name        String
  description String?
  parentId    String?
  level       Int      @default(0)
  isActive    Boolean  @default(true)

  // Audit fields
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Reverse relationship
  products    Product[]

  @@map("product_categories")
  @@index([parentId])
  @@index([isActive])
  @@index([level])
}

model Product {
  id                String    @id @default(cuid())
  name              String
  sku               String
  description       String?
  price             Decimal   @db.Decimal(10, 2)
  categoryId        String
  status            String    @default("ACTIVE")
  stockQuantity     Int       @default(0)
  lowStockThreshold Int       @default(10)
  isActive          Boolean   @default(true)

  // Audit fields
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt

  // Relationships
  category          ProductCategory @relation(fields: [categoryId], references: [id])
  stockMovements    StockMovement[] @relation("ProductStockMovements")
  orderItems        OrderItem[] @relation("OrderProductItems")

  @@map("products")
  @@unique([sku])
  @@index([categoryId])
  @@index([status])
  @@index([isActive])
  @@index([stockQuantity])
}

model StockMovement {
  id          String   @id @default(cuid())
  productId  String
  type        String    @default("IN")
  quantity    Int
  reason      String
  reference   String?
  createdById  String?

  createdAt   DateTime @default(now())

  // Relationships
  product     Product @relation("ProductStockMovements", fields: [productId], references: [id])

  @@map("stock_movements")
  @@index([productId])
  @@index([type])
  @@index([createdAt])
}

// Accounting Module - Chart of Accounts
model ChartOfAccounts {
  id          String   @id @default(cuid())
  code        String   @unique(map: "chart_of_accounts_code_unique")
  name        String
  description String?
  type        String   // ASSET, LIABILITY, EQUITY, REVENUE, EXPENSE
  category    String   // Current Assets, Fixed Assets, etc.
  subcategory String?
  parentId    String?
  level       Int      @default(0)
  isActive    Boolean  @default(true)
  isSystem    Boolean  @default(false) // System accounts cannot be deleted

  // Audit fields
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String?
  updatedBy   String?

  // Relationships
  parent      ChartOfAccounts? @relation("AccountHierarchy", fields: [parentId], references: [id])
  children    ChartOfAccounts[] @relation("AccountHierarchy")
  journalEntries JournalEntry[]

  @@map("chart_of_accounts")
    @@index([type])
  @@index([category])
  @@index([parentId])
  @@index([isActive])
}

// Accounting Module - Transactions
model Transaction {
  id          String   @id @default(cuid())
  reference   String   @unique(map: "transactions_reference_unique")
  description String
  date        DateTime @default(now())
  amount      Decimal  @db.Decimal(15, 2)
  currency    String   @default("USD")
  status      String   @default("PENDING") // PENDING, POSTED, CANCELLED
  type        String   // SALE, PURCHASE, PAYMENT, RECEIPT, ADJUSTMENT, etc.

  // Audit fields
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String?
  updatedBy   String?
  postedBy    String?
  postedAt    DateTime?

  // Relationships
  entries     JournalEntry[]

  @@map("transactions")
    @@index([date])
  @@index([status])
  @@index([type])
  @@index([createdBy])
}

// Accounting Module - Journal Entries (Double-entry bookkeeping)
model JournalEntry {
  id            String   @id @default(cuid())
  transactionId String
  accountId     String
  description   String?
  debitAmount   Decimal  @db.Decimal(15, 2) @default(0)
  creditAmount  Decimal  @db.Decimal(15, 2) @default(0)
  balance       Decimal  @db.Decimal(15, 2) @default(0)

  createdAt     DateTime @default(now())

  // Relationships
  transaction   Transaction @relation(fields: [transactionId], references: [id])
  account       ChartOfAccounts @relation(fields: [accountId], references: [id])

  @@map("journal_entries")
  @@index([transactionId])
  @@index([accountId])
  @@index([debitAmount])
  @@index([creditAmount])
}

// Sales Module - Customers
model Customer {
  id          String   @id @default(cuid())
  code        String   @unique
  name        String
  email       String   @unique
  phone       String?
  address     String?
  city        String?
  state       String?
  postalCode  String?
  country     String?
  taxId       String?
  isActive    Boolean  @default(true)
  creditLimit Decimal  @db.Decimal(15, 2) @default(0)

  // Audit fields
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String?
  updatedBy   String?

  // Relationships
  orders      Order[]
  invoices    Invoice[]

  @@map("customers")
  @@index([isActive])
  @@index([email])
}

// Sales Module - Orders
model Order {
  id          String   @id @default(cuid())
  orderNumber String   @unique
  customerId  String
  reference   String?
  description String?
  status      String   @default("DRAFT") // DRAFT, CONFIRMED, SHIPPED, DELIVERED, CANCELLED
  orderDate   DateTime @default(now())
  dueDate     DateTime?
  subtotal    Decimal  @db.Decimal(15, 2) @default(0)
  taxAmount   Decimal  @db.Decimal(15, 2) @default(0)
  totalAmount Decimal  @db.Decimal(15, 2) @default(0)
  currency    String   @default("USD")
  notes       String?

  // Audit fields
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String?
  updatedBy   String?

  // Relationships
  customer    Customer @relation(fields: [customerId], references: [id])
  orderItems  OrderItem[]
  invoice     Invoice?

  @@map("orders")
  @@index([customerId])
  @@index([status])
  @@index([orderDate])
  @@index([totalAmount])
}

// Sales Module - Order Items
model OrderItem {
  id          String   @id @default(cuid())
  orderId     String
  productId   String
  quantity    Int
  unitPrice   Decimal  @db.Decimal(10, 2)
  discount    Decimal  @db.Decimal(10, 2) @default(0)
  totalPrice  Decimal  @db.Decimal(15, 2) @default(0)
  description String?

  createdAt   DateTime @default(now())

  // Relationships
  order       Order @relation(fields: [orderId], references: [id])
  product     Product @relation("OrderProductItems", fields: [productId], references: [id])

  @@map("order_items")
  @@index([orderId])
  @@index([productId])
}

// Sales Module - Invoices
model Invoice {
  id            String   @id @default(cuid())
  invoiceNumber String   @unique
  orderId      String   @unique
  customerId    String
  status        String   @default("DRAFT") // DRAFT, SENT, PAID, OVERDUE, CANCELLED
  issueDate     DateTime @default(now())
  dueDate       DateTime?
  subtotal      Decimal  @db.Decimal(15, 2) @default(0)
  taxAmount     Decimal  @db.Decimal(15, 2) @default(0)
  totalAmount   Decimal  @db.Decimal(15, 2) @default(0)
  paidAmount    Decimal  @db.Decimal(15, 2) @default(0)
  balanceDue    Decimal  @db.Decimal(15, 2) @default(0)
  currency      String   @default("USD")
  notes         String?

  // Audit fields
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  createdBy     String?
  updatedBy     String?

  // Relationships
  customer      Customer @relation(fields: [customerId], references: [id])
  order         Order @relation(fields: [orderId], references: [id])
  payments      Payment[]

  @@map("invoices")
  @@index([customerId])
  @@index([status])
  @@index([issueDate])
  @@index([dueDate])
}

// Sales Module - Payments
model Payment {
  id            String   @id @default(cuid())
  invoiceId     String
  reference     String?
  amount        Decimal  @db.Decimal(15, 2)
  paymentMethod  String   // CASH, BANK_TRANSFER, CREDIT_CARD, CHECK, OTHER
  paymentDate   DateTime @default(now())
  status        String   @default("PENDING") // PENDING, COMPLETED, FAILED, CANCELLED
  notes         String?

  // Audit fields
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  createdBy     String?
  updatedBy     String?

  // Relationships
  invoice       Invoice @relation(fields: [invoiceId], references: [id])

  @@map("payments")
  @@index([invoiceId])
  @@index([status])
  @@index([paymentDate])
  @@index([amount])
}

// Purchasing Module - Suppliers
model Supplier {
  id          String   @id @default(cuid())
  code        String   @unique
  name        String
  email       String   @unique
  phone       String?
  address     String?
  city        String?
  state       String?
  postalCode  String?
  country     String?
  taxId       String?
  isActive    Boolean  @default(true)
  creditLimit Decimal  @db.Decimal(15, 2) @default(0)
  paymentTerms String  @default("NET30") // NET15, NET30, NET60, etc.

  // Audit fields
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String?
  updatedBy   String?

  // Relationships
  purchaseOrders PurchaseOrder[]
  performanceRecords SupplierPerformance[]
  performanceEvents SupplierPerformanceEvent[] @relation("SupplierEvents")
  performanceReviews SupplierPerformanceReview[] @relation("SupplierReviews")

  @@map("suppliers")
  @@index([isActive])
  @@index([email])
}

// Purchasing Module - Purchase Orders
model PurchaseOrder {
  id            String   @id @default(cuid())
  orderNumber   String   @unique
  supplierId    String
  reference     String?
  description   String?
  status        String   @default("DRAFT") // DRAFT, SENT, CONFIRMED, RECEIVED, CANCELLED
  orderDate     DateTime @default(now())
  expectedDate  DateTime?
  subtotal      Decimal  @db.Decimal(15, 2) @default(0)
  taxAmount     Decimal  @db.Decimal(15, 2) @default(0)
  totalAmount   Decimal  @db.Decimal(15, 2) @default(0)
  currency      String   @default("USD")
  notes         String?

  // Audit fields
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  createdBy     String?
  updatedBy     String?

  // Relationships
  supplier      Supplier @relation(fields: [supplierId], references: [id])
  orderItems    PurchaseOrderItem[]
  receipts      PurchaseReceipt[]
  performanceEvents SupplierPerformanceEvent[] @relation("OrderEvents")

  @@map("purchase_orders")
  @@index([supplierId])
  @@index([status])
  @@index([orderDate])
  @@index([totalAmount])
}

// Purchasing Module - Purchase Order Items
model PurchaseOrderItem {
  id            String   @id @default(cuid())
  orderId       String
  productId     String?
  description   String
  quantity      Int
  unitPrice     Decimal  @db.Decimal(10, 2)
  discount      Decimal  @db.Decimal(10, 2) @default(0)
  totalPrice    Decimal  @db.Decimal(15, 2) @default(0)
  receivedQty   Int      @default(0)

  createdAt     DateTime @default(now())

  // Relationships
  order         PurchaseOrder @relation(fields: [orderId], references: [id])
  performanceEvents SupplierPerformanceEvent[] @relation("ItemEvents")

  @@map("purchase_order_items")
  @@index([orderId])
  @@index([productId])
}

// Purchasing Module - Purchase Receipts
model PurchaseReceipt {
  id            String   @id @default(cuid())
  receiptNumber String   @unique
  orderId       String
  reference     String?
  status        String   @default("DRAFT") // DRAFT, CONFIRMED, CANCELLED
  receiptDate   DateTime @default(now())
  notes         String?

  // Audit fields
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  createdBy     String?
  updatedBy     String?

  // Relationships
  order         PurchaseOrder @relation(fields: [orderId], references: [id])

  @@map("purchase_receipts")
  @@index([orderId])
  @@index([status])
  @@index([receiptDate])
}

// Reports Module - Report Definitions
model ReportDefinition {
  id          String   @id @default(cuid())
  name        String
  description String?
  type        String   // FINANCIAL, SALES, INVENTORY, PURCHASING, EXECUTIVE
  category    String   // SUMMARY, DETAILED, ANALYTICS, KPI
  query       String   // SQL query or JSON definition
  parameters  Json?    // Report parameters definition
  isActive    Boolean  @default(true)
  isSystem    Boolean  @default(false) // System reports cannot be deleted

  // Audit fields
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String?
  updatedBy   String?

  // Relationships
  generatedReports GeneratedReport[]

  @@map("report_definitions")
  @@index([type])
  @@index([category])
  @@index([isActive])
}

// Reports Module - Generated Reports
model GeneratedReport {
  id            String   @id @default(cuid())
  reportDefinitionId String
  name          String
  parameters    Json?    // Used parameters
  data          Json     // Report data
  format        String   @default("JSON") // JSON, CSV, PDF, EXCEL
  status        String   @default("GENERATING") // GENERATING, COMPLETED, FAILED
  generatedAt   DateTime @default(now())
  expiresAt     DateTime? // For cached reports
  fileUrl       String?  // For exported files

  // Audit fields
  createdAt     DateTime @default(now())
  createdBy     String?

  // Relationships
  reportDefinition ReportDefinition @relation(fields: [reportDefinitionId], references: [id])

  @@map("generated_reports")
  @@index([reportDefinitionId])
  @@index([status])
  @@index([generatedAt])
  @@index([expiresAt])
}

// Reports Module - Dashboard Definitions
model Dashboard {
  id          String   @id @default(cuid())
  name        String
  description String?
  layout      Json     // Dashboard layout configuration
  widgets     Json     // Widget definitions
  isActive    Boolean  @default(true)
  isPublic    Boolean  @default(false)

  // Audit fields
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String?
  updatedBy   String?

  @@map("dashboards")
  @@index([isActive])
  @@index([isPublic])
}

// Reports Module - KPI Definitions
model KpiDefinition {
  id          String   @id @default(cuid())
  name        String
  description String?
  category    String   // FINANCIAL, SALES, INVENTORY, PURCHASING
  formula     String   // Calculation formula
  unit        String?  // Unit of measurement
  target      Decimal? @db.Decimal(15, 2)
  isActive    Boolean  @default(true)

  // Audit fields
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String?
  updatedBy   String?

  @@map("kpi_definitions")
  @@index([category])
  @@index([isActive])
}

// Supplier Performance Tracking Module - Supplier Performance Metrics
model SupplierPerformance {
  id                    String   @id @default(cuid())
  supplierId            String
  period                String   // YYYY-MM format for monthly tracking
  qualityScore          Decimal  @db.Decimal(5, 2) @default(0)    // 0-100 scale
  deliveryScore         Decimal  @db.Decimal(5, 2) @default(0)    // 0-100 scale
  costScore             Decimal  @db.Decimal(5, 2) @default(0)    // 0-100 scale
  serviceScore          Decimal  @db.Decimal(5, 2) @default(0)    // 0-100 scale
  overallScore          Decimal  @db.Decimal(5, 2) @default(0)    // Weighted average
  tier                  String   @default("STANDARD")             // PREFERRED, APPROVED, STANDARD, CONDITIONAL, UNDER_REVIEW
  onTimeDeliveryRate    Decimal  @db.Decimal(5, 2) @default(0)    // Percentage
  qualityDefectRate     Decimal  @db.Decimal(5, 2) @default(0)    // Percentage
  orderAccuracyRate     Decimal  @db.Decimal(5, 2) @default(0)    // Percentage
  priceVarianceRate     Decimal  @db.Decimal(5, 2) @default(0)    // Percentage
  responseTimeHours     Decimal  @db.Decimal(8, 2) @default(0)    // Average response time
  totalOrders           Int      @default(0)
  totalValue            Decimal  @db.Decimal(15, 2) @default(0)
  lateDeliveries        Int      @default(0)
  qualityIssues         Int      @default(0)
  returnsCount          Int      @default(0)
  notes                 String?

  // Audit fields
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  calculatedBy          String?  // User who calculated the metrics
  reviewedBy            String?  // Manager who reviewed the metrics
  reviewedAt            DateTime?

  // Relationships
  supplier              Supplier @relation(fields: [supplierId], references: [id])
  calculator            User?    @relation("PerformanceCalculator", fields: [calculatedBy], references: [id])
  reviewer              User?    @relation("PerformanceReviewer", fields: [reviewedBy], references: [id])
  scorecardDetails      SupplierScorecardDetail[]

  @@map("supplier_performance")
  @@index([supplierId])
  @@index([period])
  @@index([tier])
  @@index([overallScore])
  @@index([createdAt])
  @@unique([supplierId, period]) // One record per supplier per period
}

// Supplier Performance Scorecard Details
model SupplierScorecardDetail {
  id                    String   @id @default(cuid())
  performanceId         String
  metricType            String   // QUALITY, DELIVERY, COST, SERVICE, RESPONSIVENESS
  metricName            String   // e.g., "On-Time Delivery", "Product Quality"
  metricValue           Decimal  @db.Decimal(15, 2)
  targetValue           Decimal  @db.Decimal(15, 2)
  performanceLevel      String   // EXCELLENT, GOOD, AVERAGE, POOR, CRITICAL
  weight                Decimal  @db.Decimal(5, 2) @default(1)    // Weight in overall calculation
  score                 Decimal  @db.Decimal(5, 2) @default(0)    // Calculated score
  trend                 String?  // IMPROVING, STABLE, DECLINING
  comments              String?
  supportingData        Json?    // Additional data for calculations

  // Audit fields
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Relationships
  performance           SupplierPerformance @relation(fields: [performanceId], references: [id])

  @@map("supplier_scorecard_details")
  @@index([performanceId])
  @@index([metricType])
  @@index([performanceLevel])
}

// Supplier Performance Events
model SupplierPerformanceEvent {
  id                    String   @id @default(cuid())
  supplierId            String
  eventType             String   // LATE_DELIVERY, QUALITY_ISSUE, PRICE_INCREASE, SERVICE_COMPLAINT, EXCELLENT_SERVICE
  eventDate             DateTime
  severity              String   // LOW, MEDIUM, HIGH, CRITICAL
  description           String
  impact                String?  // Description of business impact
  resolved              Boolean  @default(false)
  resolvedAt            DateTime?
  resolvedBy            String?
  resolutionNotes       String?
  orderId               String?  // Related purchase order if applicable
  itemId                String?  // Related order item if applicable
  costImpact            Decimal  @db.Decimal(15, 2) @default(0)  // Financial impact
  preventiveAction      String?  // Actions taken to prevent recurrence

  // Audit fields
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  createdBy             String?
  updatedBy             String?

  // Relationships
  supplier              Supplier @relation("SupplierEvents", fields: [supplierId], references: [id])
  resolver              User?    @relation("EventResolver", fields: [resolvedBy], references: [id])
  relatedOrder          PurchaseOrder? @relation("OrderEvents", fields: [orderId], references: [id])
  relatedItem           PurchaseOrderItem? @relation("ItemEvents", fields: [itemId], references: [id])

  @@map("supplier_performance_events")
  @@index([supplierId])
  @@index([eventType])
  @@index([severity])
  @@index([eventDate])
  @@index([resolved])
}

// Supplier Performance Reviews
model SupplierPerformanceReview {
  id                    String   @id @default(cuid())
  supplierId            String
  reviewPeriod          String   // YYYY-MM format
  reviewType            String   // MONTHLY, QUARTERLY, ANNUAL, ADHOC
  overallRating         String   // EXCELLENT, GOOD, SATISFACTORY, NEEDS_IMPROVEMENT, UNSATISFACTORY
  strengths             String[] // Array of supplier strengths
  weaknesses            String[] // Array of supplier weaknesses
  recommendations       String[] // Array of improvement recommendations
  actionItems           Json?    // Action items with responsibilities and deadlines
  nextReviewDate        DateTime?
  status                String   @default("PENDING") // PENDING, IN_PROGRESS, COMPLETED, CANCELLED
  reviewedBy            String   // Manager who conducted the review
  reviewDate            DateTime @default(now())
  reviewComments        String?
  followUpRequired      Boolean  @default(false)
  followUpDate          DateTime?

  // Audit fields
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  completedAt           DateTime?

  // Relationships
  supplier              Supplier @relation("SupplierReviews", fields: [supplierId], references: [id])
  reviewer              User @relation("PerformanceReviewBy", fields: [reviewedBy], references: [id])

  @@map("supplier_performance_reviews")
  @@index([supplierId])
  @@index([reviewPeriod])
  @@index([reviewType])
  @@index([overallRating])
  @@index([status])
}